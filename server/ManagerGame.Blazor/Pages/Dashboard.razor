@page "/dashboard"
@using ManagerGame.Core
@using ManagerGame.Domain
@using ManagerGame.Blazor.Services
@using MudBlazor
@inject ApplicationDbContext DbContext
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject CurrentManagerService CurrentManager

<PageTitle>Kontrollpanel - Fantasy Manager</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    @if (_isLoading)
    {
        <div class="d-flex justify-center pa-6">
            <MudProgressCircular Indeterminate="true" />
        </div>
    }
    else
    {
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h3" Class="mb-4">Välkommen till din Kontrollpanel</MudText>
            <MudText Typo="Typo.subtitle1" Class="mb-8">Här kan du hantera dina lag och ligor</MudText>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard Class="mb-6" Style="height: 100%;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">Mina lag</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Href="/dashboard#join-league" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    @if (myTeams.Any())
                    {
                        <MudList T="Team">
                            @foreach (var team in myTeams)
                            {
                                <MudListItem T="Team" Href="@($"/team/{team.Id}")">
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText>@team.Name.Name</MudText>
                                        <MudChip T="string" Color="Color.Primary" Size="Size.Small">@team.TotalPoints poäng</MudChip>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Du har inga lag ännu.</MudAlert>
                        <MudButton Class="mt-4" Variant="Variant.Filled" Color="Color.Primary" Href="/dashboard#join-league">Gå med i en liga</MudButton>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard Class="mb-6" Style="height: 100%;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">Mina ligor</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Success" Href="/create-league" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    @if (myLeagues.Any())
                    {
                        <MudList T="League">
                            @foreach (var league in myLeagues)
                            {
                                <MudListItem T="League" Href="@($"/league/{league.Id}")">
                                    @league.Name
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Du är inte med i någon liga ännu.</MudAlert>
                        <MudButton Class="mt-4" Variant="Variant.Filled" Color="Color.Success" Href="/create-league">Skapa en liga</MudButton>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard Class="mb-6" Style="height: 100%;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">Gå med i en liga</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent id="join-league">
                    <MudText>Har du en inbjudningskod? Använd den för att gå med i en liga.</MudText>
                    <MudTextField @bind-Value="joinLeagueModel.InviteCode" Label="Inbjudningskod"
                                  Variant="Variant.Outlined" Class="mt-3" />
                    <MudButton Class="mt-3" Variant="Variant.Filled" Color="Color.Primary"
                              OnClick="JoinLeague" FullWidth="true">Gå med</MudButton>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">Kommande matcher</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudAlert Severity="Severity.Info">Det finns inga kommande matcher just nu.</MudAlert>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">Topplista</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudAlert Severity="Severity.Info">Välj en liga för att se topplistan.</MudAlert>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
    }
</MudContainer>

@code {
    private List<Team> myTeams = new();
    private List<League> myLeagues = new();
    private JoinLeagueModel joinLeagueModel = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        // Session (ProtectedLocalStorage) is loaded after first render.
        await Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        await CurrentManager.InitializeAsync();
        if (CurrentManager.ManagerId is null)
        {
            NavigationManager.NavigateTo("/login", true);
            return;
        }

        await LoadDashboardData(CurrentManager.ManagerId.Value);
        _isLoading = false;
        StateHasChanged();
    }

    private async Task LoadDashboardData(Guid managerId)
    {
        myTeams = (await DbContext.Teams2.GetAll())
            .Where(t => t.ManagerId == managerId)
            .ToList();

        myLeagues = (await DbContext.Leagues2.GetAll())
            .Where(l => l.Teams.Any(t => t.ManagerId == managerId))
            .ToList();
    }

    private async Task JoinLeague()
    {
        try
        {
            await CurrentManager.InitializeAsync();
            if (CurrentManager.ManagerId is null)
            {
                NavigationManager.NavigateTo("/login", true);
                return;
            }

            if (string.IsNullOrWhiteSpace(joinLeagueModel.InviteCode))
            {
                Snackbar.Add("Inbjudningskod krävs", Severity.Warning);
                return;
            }

            var leagues = await DbContext.Leagues2.GetAll();
            var league = leagues.FirstOrDefault(l => l.InviteCode == joinLeagueModel.InviteCode);

            if (league == null)
            {
                Snackbar.Add("Ogiltig inbjudningskod", Severity.Error);
                return;
            }

            // Joining happens by creating a team in the league on the league page
            Snackbar.Add("Liga hittad! Skapa ett lag för att gå med.", Severity.Info);
            joinLeagueModel.InviteCode = string.Empty;

            NavigationManager.NavigateTo($"/league/{league.Id}", true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Kunde inte gå med i ligan: {ex.Message}", Severity.Error);
        }
    }

    private class JoinLeagueModel
    {
        public string InviteCode { get; set; } = string.Empty;
    }
}
